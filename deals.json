import requests, re, json
from bs4 import BeautifulSoup

AFFILIATE_TAG = "discoshop-21"
AMAZON_DEALS_URL = "https://www.amazon.in/gp/goldbox?ref_=nav_cs_gb"

def fetch_amazon_deals():
    headers = {"User-Agent": "Mozilla/5.0"}
    r = requests.get(AMAZON_DEALS_URL, headers=headers)
    soup = BeautifulSoup(r.text, "html.parser")

    items = []
    for div in soup.select("div.DealCard-module__card_2xY3L"):
        title = div.select_one("span.DealCard-module__truncate_3zZvx")
        link = div.select_one("a")
        img = div.select_one("img")
        price = div.select_one("span.a-price-whole")
        if title and link:
            url = "https://www.amazon.in" + link.get("href")
            if "tag=" not in url:
                url += f"&tag={AFFILIATE_TAG}"
            items.append({
                "title": title.get_text(strip=True),
                "price_text": price.get_text(strip=True) if price else "",
                "link": url,
                "image": img.get("src") if img else "",
                "source": "Amazon"
            })

    return {"deals": items[:50]}

if __name__ == "__main__":
    data = fetch_amazon_deals()
    with open("deals.json", "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
