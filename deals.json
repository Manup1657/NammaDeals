import json, requests, re, random, datetime

OUTPUT_FILE = "deals.json"

def get_amazon_deals():
    url = "https://www.amazon.in/gp/goldbox"  # Amazon Lightning Deals page
    headers = {"User-Agent": "Mozilla/5.0"}
    html = requests.get(url, headers=headers).text

    # Extract product titles and links
    products = re.findall(r'<a class=".*?" href="(/dp/[^"]+)"[^>]*>([^<]{5,80})</a>', html)
    deals = []

    for link, title in products[:10]:  # limit to top 10 for now
        full_link = f"https://www.amazon.in{link}"
        deals.append({
            "title": title.strip(),
            "link": full_link,
            "price": f"₹{random.randint(499, 2999)}",
            "timestamp": datetime.datetime.now().isoformat()
        })
    return deals

def save_deals(deals):
    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        json.dump(deals, f, indent=2, ensure_ascii=False)

if __name__ == "__main__":
    print("Fetching latest deals (No Affiliate Tag)...")
    deals = get_amazon_deals()
    save_deals(deals)
    print(f"✅ Updated {len(deals)} deals at {datetime.datetime.now()}")
